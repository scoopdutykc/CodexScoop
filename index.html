<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Scoop Duty — Pet Waste Removal in the KC Metro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    .service-card:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0,0,0,.1), 0 10px 10px -5px rgba(0,0,0,.04); }
  </style>
</head>
<body class="font-sans bg-gray-50">
  <nav class="bg-white shadow-md sticky top-0 z-50">
    <div class="container mx-auto px-6 py-4">
      <div class="flex justify-between items-center">
        <div class="text-2xl font-bold text-green-600">
          Scoop Duty <span class="text-green-800"></span>
        </div>
        <div class="hidden md:flex space-x-3">
          <a id="navBilling" href="/billing" class="hidden px-4 py-2 rounded-md bg-gray-100 hover:bg-gray-200 transition font-medium">
            Billing
          </a>
          <button id="loginBtn" class="px-4 py-2 rounded-md bg-green-600 text-white hover:bg-green-700 transition font-medium">
            Login
          </button>
          <button id="signupBtn" class="px-4 py-2 rounded-md bg-green-800 text-white hover:bg-green-900 transition font-medium">
            Sign Up
          </button>
        </div>
        <button class="md:hidden focus:outline-none"><i data-feather="menu"></i></button>
      </div>
    </div>
  </nav>

  <section class="relative bg-gray-100">
    <img src="images/hero.jpg" 
       alt="Happy dog ready for a clean yard" 
       class="w-full max-h-[60vh] object-contain mx-auto">
  </section>

  <section id="services" class="py-20 bg-white">
    <div class="container mx-auto px-6">
      <h2 class="text-3xl font-bold text-center text-gray-800 mb-16" data-aos="fade-up">Our Services</h2>
      <div class="grid md:grid-cols-3 gap-8">
        <div class="service-card bg-white p-8 rounded-xl shadow-lg transition duration-300" data-aos="fade-up" data-aos-delay="100">
          <div class="text-green-600 mb-4"><i data-feather="home" class="w-10 h-10"></i></div>
          <h3 class="text-xl font-bold mb-3 text-gray-800">Yard Scooping</h3>
          <p class="text-gray-600">Professional pet waste removal to keep your yard clean and sanitary.</p>
        </div>
        <div class="service-card bg-white p-8 rounded-xl shadow-lg transition duration-300" data-aos="fade-up" data-aos-delay="200">
          <div class="text-green-600 mb-4"><i data-feather="activity" class="w-10 h-10"></i></div>
          <h3 class="text-xl font-bold mb-3 text-gray-800">Doggy Playtime</h3>
          <p class="text-gray-600">Fun and engaging play sessions for your furry friends while you're away.</p>
        </div>
        <div class="service-card bg-white p-8 rounded-xl shadow-lg transition duration-300" data-aos="fade-up" data-aos-delay="300">
          <div class="text-green-600 mb-4"><i data-feather="box" class="w-10 h-10"></i></div>
          <h3 class="text-xl font-bold mb-3 text-gray-800">Litter Trade</h3>
          <p class="text-gray-600">Regular litter box cleaning and fresh litter replacement service.</p>
        </div>
      </div>
    </div>
  </section>

  <section id="pricing" class="py-20 bg-gray-50">
    <div class="container mx-auto px-6">
      <h2 class="text-3xl font-bold text-center text-gray-800 mb-16" data-aos="fade-up">Simple Pricing</h2>

      <div class="max-w-4xl mx-auto" data-aos="fade-up">
        <div class="mb-6">
          <select id="serviceType" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 text-gray-700 font-medium">
            <option value="yard-scooping">Yard Scooping</option>
            <option value="doggy-playtime">Doggy Playtime</option>
            <option value="litter-trade">Litter Trade</option>
          </select>
        </div>

        <div id="yard-scooping-options" class="bg-white rounded-xl shadow-lg overflow-hidden">
          <div class="md:flex">
            <div class="p-8 md:w-1/2 bg-green-50">
              <h3 class="text-2xl font-bold text-green-700 mb-4">Yard Scooping</h3>
              <div class="space-y-6">
                <div>
                  <label class="block text-gray-700 font-medium mb-2">Frequency</label>
                  <select data-field="frequency" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                    <option>One-Time</option>
                    <option>Weekly</option>
                    <option>Twice Weekly</option>
                    <option>Three Weekly</option>
                  </select>
                </div>
                <div>
                  <label class="block text-gray-700 font-medium mb-2">Yard Size</label>
                  <select data-field="yardSize" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                    <option>Small Yard (under 5,000 sq ft)</option>
                    <option>Medium Yard (5,000-10,000 sq ft)</option>
                    <option>Large Yard (over 10,000 sq ft)</option>
                  </select>
                </div>
                <div>
                  <label class="block text-gray-700 font-medium mb-2">Number of Pets</label>
                  <select data-field="pets" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                    <option>1 Dog</option>
                    <option>2 Dogs</option>
                    <option>3 Dogs</option>
                    <option>4 Dogs</option>
                    <option>5+ Dogs</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="p-8 md:w-1/2 flex flex-col justify-center items-center bg-white">
              <div class="text-center">
                <div class="js-price text-4xl font-bold text-green-600 mb-2">$—</div>
                <div class="js-frequency-label text-gray-600 mb-6">weekly</div>
                <button class="js-checkout-btn bg-green-600 text-white px-8 py-3 rounded-full font-semibold hover:bg-green-700 transition">
                  Get Started
                </button>
                <div class="js-note mt-2 text-sm text-gray-500"></div>
              </div>
            </div>
          </div>
        </div>

        <div id="doggy-playtime-options" class="bg-white rounded-xl shadow-lg overflow-hidden hidden">
          <div class="md:flex">
            <div class="p-8 md:w-1/2 bg-green-50">
              <h3 class="text-2xl font-bold text-green-700 mb-4">Doggy Playtime</h3>
              <div class="space-y-6">
                <div>
                  <label class="block text-gray-700 font-medium mb-2">Frequency</label>
                  <select data-field="frequency" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                    <option>One-Time</option>
                    <option>Weekly</option>
                    <option>Twice Weekly</option>
                    <option>Three Weekly</option>
                  </select>
                </div>
                <div>
                  <label class="block text-gray-700 font-medium mb-2">Number of Pets</label>
                  <select data-field="pets" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                    <option>1 Dog</option>
                    <option>2 Dogs</option>
                    <option>3 Dogs</option>
                    <option>4 Dogs</option>
                    <option>5+ Dogs</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="p-8 md:w-1/2 flex flex-col justify-center items-center bg-white">
              <div class="text-center">
                <div class="js-price text-4xl font-bold text-green-600 mb-2">$—</div>
                <div class="js-frequency-label text-gray-600 mb-6">weekly</div>
                <button class="js-checkout-btn bg-green-600 text-white px-8 py-3 rounded-full font-semibold hover:bg-green-700 transition">
                  Get Started
                </button>
                <div class="js-note mt-2 text-sm text-gray-500"></div>
              </div>
            </div>
          </div>
        </div>

        <div id="litter-trade-options" class="bg-white rounded-xl shadow-lg overflow-hidden hidden">
          <div class="md:flex">
            <div class="p-8 md:w-1/2 bg-green-50">
              <h3 class="text-2xl font-bold text-green-700 mb-4">Litter Trade</h3>
              <div class="space-y-6">
                <div>
                  <label class="block text-gray-700 font-medium mb-2">Frequency</label>
                  <select data-field="frequency" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                    <option>One-Time</option>
                    <option>Weekly</option>
                    <option>Twice Weekly</option>
                    <option>Three Weekly</option>
                  </select>
                </div>
                <div>
                  <label class="block text-gray-700 font-medium mb-2">Number of Boxes</label>
                  <select data-field="boxes" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                    <option>1 Box</option>
                    <option>2 Boxes</option>
                    <option>3 Boxes</option>
                    <option>4+ Boxes</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="p-8 md:w-1/2 flex flex-col justify-center items-center bg-white">
              <div class="text-center">
                <div class="js-price text-4xl font-bold text-green-600 mb-2">$—</div>
                <div class="js-frequency-label text-gray-600 mb-6">weekly</div>
                <button class="js-checkout-btn bg-green-600 text-white px-8 py-3 rounded-full font-semibold hover:bg-green-700 transition">
                  Get Started
                </button>
                <div class="js-note mt-2 text-sm text-gray-500"></div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </section>

  <section id="faq" class="py-20 bg-white">
    <div class="container mx-auto px-6 max-w-4xl">
      <h2 class="text-3xl font-bold text-center text-gray-800 mb-16" data-aos="fade-up">Frequently Asked Questions</h2>
      <div class="space-y-6">
        <div class="border-b pb-4" data-aos="fade-up">
          <button class="flex justify-between items-center w-full text-left focus:outline-none">
            <h3 class="text-lg font-medium text-gray-800">What areas does Scoop Duty service?</h3>
            <i data-feather="chevron-down" class="text-green-600"></i>
          </button>
          <div class="mt-2 text-gray-600">We proudly service the Greater Kansas City Area. Email us at scoopdutykc@gmail.com for more info on your location</div>
        </div>
        <div class="border-b pb-4" data-aos="fade-up" data-aos-delay="100">
          <button class="flex justify-between items-center w-full text-left focus:outline-none">
            <h3 class="text-lg font-medium text-gray-800">What do you do with the waste after cleaning?</h3>
            <i data-feather="chevron-down" class="text-green-600"></i>
          </button>
          <div class="mt-2 text-gray-600">We take it with us and properly dispose of it at one of our partnered sites.</div>
        </div>
        <div class="border-b pb-4" data-aos="fade-up" data-aos-delay="200">
          <button class="flex justify-between items-center w-full text-left focus:outline-none">
            <h3 class="text-lg font-medium text-gray-800">When is my start date?</h3>
            <i data-feather="chevron-down" class="text-green-600"></i>
          </button>
          <div class="mt-2 text-gray-600">After checkout, choose a preferred date. We'll email you your start date.</div>
        </div>
        <div class="border-b pb-4" data-aos="fade-up" data-aos-delay="300">
          <button class="flex justify-between items-center w-full text-left focus:outline-none">
            <h3 class="text-lg font-medium text-gray-800">How do I pay?</h3>
            <i data-feather="chevron-down" class="text-green-600"></i>
          </button>
          <div class="mt-2 text-gray-600">All payments are securely handled through our Stripe-powered billing portal.</div>
        </div>
        <div class="border-b pb-4" data-aos="fade-up" data-aos-delay="400">
          <button class="flex justify-between items-center w-full text-left focus:outline-none">
            <h3 class="text-lg font-medium text-gray-800">How often will I be charged?</h3>
            <i data-feather="chevron-down" class="text-green-600"></i>
          </button>
          <div class="mt-2 text-gray-600">You'll be billed weekly, even if you are on twice or three times weekly visits.</div>
        </div>
      </div>
    </div>
  </section>

  <footer class="bg-gray-800 text-white py-12">
    <div class="container mx-auto px-6">
      <div class="md:flex md:justify-between">
        <div class="mb-8 md:mb-0">
          <h3 class="text-2xl font-bold mb-4">Scoop Duty</h3>
          <p class="text-gray-400">Professional pet waste removal serving the Kansas City metro area.</p>
        </div>
        <div class="grid grid-cols-2 gap-8">
          <div>
            <h4 class="text-lg font-semibold mb-4">Quick Links</h4>
            <ul class="space-y-2">
              <li><a href="#services" class="text-gray-400 hover:text-white">Services</a></li>
              <li><a href="#pricing" class="text-gray-400 hover:text-white">Pricing</a></li>
              <li><a href="#faq" class="text-gray-400 hover:text-white">FAQ</a></li>
            </ul>
          </div>
          <div>
            <h4 class="text-lg font-semibold mb-4">Contact</h4>
            <ul class="space-y-2">
              <li class="flex items-center text-gray-400"><i data-feather="mail" class="mr-2"></i> https://www.scoop-duty.com</li>
              <li class="flex items-center text-gray-400"><i data-feather="phone" class="mr-2"></i> Soon</li>
            </ul>
          </div>
        </div>
      </div>
      <div class="border-t border-gray-700 mt-8 pt-8 text-center text-gray-400">
        <p>&copy; 2025 Scoop Duty. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <script>
    // Firebase config (your literals kept; can be overridden by /api/public-env if provided)
    const firebaseConfig = {
      apiKey: "AIzaSyBiCaBDOOql_0MO1KRWaATh-ATc60TutMw",
      authDomain: "scoop-duty.firebaseapp.com",
      projectId: "scoop-duty",
      storageBucket: "scoop-duty.firebasestorage.app",
      messagingSenderId: "888851571683",
      appId: "1:888851571683:web:d48f67ba25c6bd780bb6d6"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    let stripe = null;
    async function initStripe() {
      if (stripe) return stripe;
      const res = await fetch('/api/public-env');
      const data = await res.json();
      console.log('public-env', data);
      if (!data.publishableKey) {
        console.error('Missing STRIPE_PUBLISHABLE_KEY from server');
      }
      stripe = Stripe(data.publishableKey || '');
      return stripe;
    }

    AOS.init({ duration: 800, easing: 'ease-in-out', once: true });
    feather.replace();

    auth.onAuthStateChanged(async (user) => {
      const loginBtn = document.getElementById('loginBtn');
      const signupBtn = document.getElementById('signupBtn');
      if (user) {
        if (loginBtn) loginBtn.textContent = 'Billing';
        if (signupBtn) signupBtn.textContent = 'Logout';
        await createStripeCustomer(user);
      } else {
        if (loginBtn) loginBtn.textContent = 'Login';
        if (signupBtn) signupBtn.textContent = 'Sign Up';
      }
    });

    document.getElementById('loginBtn').addEventListener('click', () => {
      if (auth.currentUser) {
        window.location.href = '/billing';
      } else {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider)
          .then(async (result) => { await createStripeCustomer(result.user); })
          .catch((error) => console.error('Login error:', error));
      }
    });

    document.getElementById('signupBtn').addEventListener('click', () => {
      if (auth.currentUser) {
        auth.signOut();
      } else {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider)
          .then(async (result) => { await createStripeCustomer(result.user); })
          .catch((error) => console.error('Signup error:', error));
      }
    });

    async function createStripeCustomer(user) {
      try {
        const resp = await fetch('/api/create-customer', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${await user.getIdToken()}`
          },
          body: JSON.stringify({
            email: user.email,
            name: user.displayName || '',
            firebaseUid: user.uid
          })
        });
        const data = await resp.json();
        return data.customerId;
      } catch (e) {
        console.error('Error creating Stripe customer:', e);
        return null;
      }
    }

    const usd = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });
    const norm = s => (s || '').toLowerCase().replace(/\s+/g,' ').trim();

    const PRICE_TABLE = {
      'onetime yard scooping': 25.00,
      'onetime doggy playtime': 30.00,
      'onetime litter trade': 20.00,
      'three weekly, 4+ boxes': 37.50,
      'three weekly, 1 box': 22.50,
      'once weekly, 4+ boxes': 25.00,
      'twice weekly, 2 boxes': 22.50,
      'twice weekly, 4+ boxes': 32.50,
      'once weekly, 1 box': 10.00,
      'once weekly, 3 boxes': 20.00,
      'twice weekly, 3 boxes': 27.50,
      'three weekly, 3 boxes': 32.50,
      'three weekly, 2 boxes': 27.50,
      'twice weekly, 1 box': 17.50,
      'once weekly, 2 boxes': 15.00,
      'three weekly, 5+ dogs': 85.00,
      'twice weekly, 5+ dogs': 75.00,
      'one weekly, 5+ dogs': 60.00,
      'three weekly, 4 dogs': 75.00,
      'twice weekly, 4 dogs': 65.00,
      'once weekly, 4 dogs': 50.00,
      'three weekly, 3 dogs': 65.00,
      'twice weekly, 3 dogs': 55.00,
      'once weekly, 3 dogs': 40.00,
      'three weekly, 2 dogs': 55.00,
      'twice weekly, 2 dogs': 45.00,
      'once weekly, 2 dogs': 30.00,
      'three weekly, 1 dog': 45.00,
      'twice weekly, 1 dog': 35.00,
      'once weekly, 1 dog': 20.00,
      'three weekly, 5+ dogs, large yard': 60.00,
      'three weekly, 5+ dogs, medium yard': 55.00,
      'three weekly, 5+ dogs, small yard': 50.00,
      'three weekly, 4 dogs, large yard': 55.00,
      'three weekly, 4 dogs, medium yard': 50.00,
      'three weekly, 4 dogs, small yard': 45.00,
      'three weekly, 3 dogs, large yard': 50.00,
      'three weekly, 3 dogs, medium yard': 45.00,
      'three weekly, 3 dogs, small yard': 40.00,
      'three weekly, 2 dogs, large yard': 45.00,
      'three weekly, 2 dogs, medium yard': 40.00,
      'three weekly, 2 dogs, small yard': 35.00,
      'three weekly, 1 dog, large yard': 40.00,
      'three weekly, 1 dog, medium yard': 35.00,
      'three weekly, 1 dog, small yard': 30.00,
      'twice weekly, 5 dogs, large yard': 55.00,
      'twice weekly, 4 dogs, large yard': 50.00,
      'twice weekly, 3 dogs, large yard': 45.00,
      'twice weekly, 2 dogs, large yard': 40.00,
      'twice weekly, 5+ dogs, medium yard': 50.00,
      'twice weekly, 4 dogs, medium yard': 45.00,
      'twice weekly, 4 dogs, small yard': 40.00,
      'twice weekly, 1 dog, large yard': 35.00,
      'twice weekly, 1 dog, medium yard': 30.00,
      'twice weekly, 1 dog, small yard': 25.00,
      'twice weekly, 3 dogs, small yard': 35.00,
      'twice weekly, 2 dogs, small yard': 30.00,
      'once weekly, 5+ dogs, large yard': 50.00,
      'once weekly, 5+ dogs, medium yard': 45.00,
      'once weekly, 5+ dogs, small yard': 40.00,
      'once weekly, 4 dogs, large yard': 45.00,
      'once weekly, 4 dogs, medium yard': 40.00,
      'once weekly, 4 dogs, small yard': 35.00,
      'once weekly, 3 dogs, large yard': 35.00,
      'once weekly, 3 dogs, medium yard': 30.00,
      'once weekly, 3 dogs, small yard': 25.00,
      'once weekly, 2 dogs, large yard': 30.00,
      'once weekly, 2 dogs, medium yard': 25.00,
      'once weekly, 2 dogs, small yard': 20.00,
      'once weekly, 1 dog, large yard': 25.00,
      'once weekly, 1 dog, medium yard': 20.00,
      'once weekly, 1 dog, small yard': 15.00
    };

    const aliasKeys = (k) => {
      const out = new Set([k]);
      if (k.includes('once weekly')) out.add(k.replace('once weekly','one weekly'));
      if (k.includes('one weekly')) out.add(k.replace('one weekly','once weekly'));
      if (k.includes('5+ dogs')) out.add(k.replace('5+ dogs','5 dogs'));
      if (k.includes('5 dogs')) out.add(k.replace('5 dogs','5+ dogs'));
      if (/^three weekly/i.test(k)) out.add(k.replace(/^Three weekly/,'three weekly'));
      return Array.from(out);
    };

    // Recognize "Twice Weekly" (and accept legacy "Bi-Weekly")
    const toCsvFreq = (ui) => {
      const v = norm(ui);
      if (v.includes('one-time')) return 'onetime';
      if (v === 'weekly') return 'once weekly';
      if (v === 'twice weekly' || v === 'bi-weekly') return 'twice weekly';
      if (v === 'three weekly') return 'three weekly';
      return v;
    };

    const toCsvPets  = (ui) => norm(ui);
    const toCsvYard  = (ui) => {
      const l = norm(ui);
      if (l.startsWith('small'))  return 'small yard';
      if (l.startsWith('medium')) return 'medium yard';
      if (l.startsWith('large'))  return 'large yard';
      return '';
    };
    const toCsvBoxes = (ui) => norm(ui);

    const serviceTypeEl = document.getElementById('serviceType');
    serviceTypeEl.addEventListener('change', () => {
      document.querySelectorAll('[id$="-options"]').forEach(el => el.classList.add('hidden'));
      document.getElementById(`${serviceTypeEl.value}-options`).classList.remove('hidden');
      updatePrice();
    });

    function buildKey() {
      const service = serviceTypeEl.value;
      if (service === 'yard-scooping') {
        const wrap = document.getElementById('yard-scooping-options');
        const f = toCsvFreq(wrap.querySelector('select[data-field="frequency"]').value);
        if (f === 'onetime') return 'onetime yard scooping';
        const pets = toCsvPets(wrap.querySelector('select[data-field="pets"]').value);
        const yard = toCsvYard(wrap.querySelector('select[data-field="yardSize"]').value);
        return norm(`${f}, ${pets}, ${yard}`);
      }
      if (service === 'doggy-playtime') {
        const wrap = document.getElementById('doggy-playtime-options');
        const f = toCsvFreq(wrap.querySelector('select[data-field="frequency"]').value);
        if (f === 'onetime') return 'onetime doggy playtime';
        const pets = toCsvPets(wrap.querySelector('select[data-field="pets"]').value);
        return norm(`${f}, ${pets}`);
      }
      if (service === 'litter-trade') {
        const wrap = document.getElementById('litter-trade-options');
        const f = toCsvFreq(wrap.querySelector('select[data-field="frequency"]').value);
        if (f === 'onetime') return 'onetime litter trade';
        const boxes = toCsvBoxes(wrap.querySelector('select[data-field="boxes"]').value);
        return norm(`${f}, ${boxes}`);
      }
      return '';
    }

    function lookupPrice(key) {
      if (!key) return null;
      for (const k of aliasKeys(key)) {
        const val = PRICE_TABLE[norm(k)];
        if (val !== undefined) return val;
      }
      return null;
    }

    function updatePrice() {
      const service = serviceTypeEl.value;
      const wrap = document.getElementById(`${service}-options`);
      const priceEl = wrap.querySelector('.js-price');
      const noteEl  = wrap.querySelector('.js-note');
      const freqLabelEl = wrap.querySelector('.js-frequency-label');

      const key = buildKey();
      const price = lookupPrice(key);

      if (price != null) {
        priceEl.textContent = usd.format(price);
        if (noteEl) noteEl.textContent = '';
      } else {
        priceEl.textContent = '$—';
        if (noteEl) noteEl.textContent = key ? `No CSV match: "${key}"` : '';
      }

      const freqUI = wrap.querySelector('select[data-field="frequency"]').value;
      const isOneTime = /one-time/i.test(freqUI);
      if (freqLabelEl) freqLabelEl.textContent = isOneTime ? 'one time' : 'weekly';
    }

    document.getElementById('pricing').addEventListener('change', (e) => {
      if (e.target.tagName === 'SELECT') updatePrice();
    });

    // === EXACT Price IDs from your table ===
    const PRICE_IDS = {
      // Onetime services
      "onetime yard scooping": "price_1S4SQLRzSCSZiE1R6YBer4cZ",
      "onetime doggy playtime": "price_1S4SPURzSCSZiE1RrLUYru5Z",
      "onetime litter trade":   "price_1S4SP8RzSCSZiE1RGHuQugOG",

      // Kitty Litter Trade
      "three weekly, 4+ boxes": "price_1S4SMkRzSCSZiE1R7NfCh5SK",
      "three weekly, 1 box":    "price_1S4SMkRzSCSZiE1RSsgGk0q0",
      "once weekly, 4+ boxes":  "price_1S4SMkRzSCSZiE1RTnjCXsc1",
      "twice weekly, 2 boxes":  "price_1S4SMkRzSCSZiE1RDKVJEEhC",
      "twice weekly, 4+ boxes": "price_1S4SMkRzSCSZiE1RQvJhd8Qf",
      "once weekly, 1 box":     "price_1S4SMkRzSCSZiE1RJfqUq3lG",
      "once weekly, 3 boxes":   "price_1S4SMkRzSCSZiE1RAdpBMbZo",
      "twice weekly, 3 boxes":  "price_1S4SMkRzSCSZiE1RzyBnrWuL",
      "three weekly, 3 boxes":  "price_1S4SMkRzSCSZiE1Ra3vgD0at",
      "three weekly, 2 boxes":  "price_1S4SMkRzSCSZiE1Ry3Y3e4uj",
      "twice weekly, 1 box":    "price_1S4SMkRzSCSZiE1RNWAoEUNN",
      "once weekly, 2 boxes":   "price_1S4SMjRzSCSZiE1RYjwR8hZA",

      // Doggy Playtime (dogs)
      "three weekly, 5+ dogs": "price_1S4S97RzSCSZiE1R4TlRQ9SJ",
      "twice weekly, 5+ dogs": "price_1S4S8uRzSCSZiE1Rjmo5rn1Q",
      "once weekly, 5+ dogs":  "price_1S4S8hRzSCSZiE1RA92U91Ga",
      "three weekly, 4 dogs":  "price_1S4S8HRzSCSZiE1RJH9QitJg",
      "twice weekly, 4 dogs":  "price_1S4S83RzSCSZiE1RhQkTV8lH",
      "once weekly, 4 dogs":   "price_1S4S7oRzSCSZiE1Rfy3pd2fO",
      "three weekly, 3 dogs":  "price_1S4S6xRzSCSZiE1Ri8Juk6tL",
      "twice weekly, 3 dogs":  "price_1S4S6SRzSCSZiE1RHaGiU7oO",
      "once weekly, 3 dogs":   "price_1S4S5xRzSCSZiE1RdpJPI75j",
      "three weekly, 2 dogs":  "price_1S4S4YRzSCSZiE1RuTO78vgQ",
      "twice weekly, 2 dogs":  "price_1S4S3hRzSCSZiE1Re5I1ytX6",
      "once weekly, 2 dogs":   "price_1S4S2rRzSCSZiE1RAqBqGoBL",
      "three weekly, 1 dog":   "price_1S4S2DRzSCSZiE1RAC39V5di",
      "twice weekly, 1 dog":   "price_1S4S1tRzSCSZiE1RERtiU3Zw",
      "once weekly, 1 dog":    "price_1S4S1SRzSCSZiE1Rs3s26GTk",

      // Yard Scooping (dogs + yard)
      "three weekly, 5+ dogs, large yard":   "price_1S4RxKRzSCSZiE1RjnD3PZbL",
      "three weekly, 5+ dogs, medium yard":  "price_1S4RwxRzSCSZiE1R7jjcmcMS",
      "three weekly, 5+ dogs, small yard":   "price_1S4RKQRzSCSZiE1RmyKeMoYZ",

      "three weekly, 4 dogs, large yard":    "price_1S4RJrRzSCSZiE1RC0HItdl5",
      "three weekly, 4 dogs, medium yard":   "price_1S4RJTRzSCSZiE1RAbqPqxWk",
      "three weekly, 4 dogs, small yard":    "price_1S4RJ7RzSCSZiE1R38EK1Prs",

      "three weekly, 3 dogs, large yard":    "price_1S4RIoRzSCSZiE1Rb3O6sGSb",
      "three weekly, 3 dogs, medium yard":   "price_1S4RI4RzSCSZiE1R7qofG6ZP",
      "three weekly, 3 dogs, small yard":    "price_1S4RHcRzSCSZiE1RhAE1PWEK",

      "three weekly, 2 dogs, large yard":    "price_1S4RGURzSCSZiE1RTvSi6W2k",
      "three weekly, 2 dogs, medium yard":   "price_1S4RFvRzSCSZiE1RzTuZUfES",
      "three weekly, 2 dogs, small yard":    "price_1S4RFZRzSCSZiE1Rm8ko1qkC",

      "three weekly, 1 dog, large yard":     "price_1S4RFCRzSCSZiE1RHUYYE5Bt",
      "three weekly, 1 dog, medium yard":    "price_1S4REVRzSCSZiE1RWRtDQEXV",
      "three weekly, 1 dog, small yard":     "price_1S4REARzSCSZiE1RQbt0iX0f",

      "twice weekly, 5 dogs, large yard":    "price_1S4RBPRzSCSZiE1RWvMkUaNg",
      "twice weekly, 4 dogs, large yard":    "price_1S4RB7RzSCSZiE1Rnj8Orwaj",
      "twice weekly, 3 dogs, large yard":    "price_1S4RAQRzSCSZiE1Rln1WsHE1",
      "twice weekly, 2 dogs, large yard":    "price_1S4RA8RzSCSZiE1RjYqqmT49",

      "twice weekly, 5+ dogs, medium yard":  "price_1S4R9fRzSCSZiE1R4sVC1peo",
      "twice weekly, 4 dogs, medium yard":   "price_1S4R9LRzSCSZiE1RExy6g1TQ",
      "twice weekly, 3 dogs, medium yard":   "price_1S4R8uRzSCSZiE1R9UDz913w",
      "twice weekly, 2 dogs, medium yard":   "price_1S4R7rRzSCSZiE1RGBu448IQ",

      "twice weekly, 5+ dogs, small yard":   "price_1S4R72RzSCSZiE1RI2EfZcog",
      "twice weekly, 4 dogs, small yard":    "price_1S4R6eRzSCSZiE1ReY37iOPp",
      "twice weekly, 1 dog, large yard":     "price_1S4R6ARzSCSZiE1RhUbHCrYA",
      "twice weekly, 1 dog, medium yard":    "price_1S4R5bRzSCSZiE1REa5M4LIA",
      "twice weekly, 3 dogs, small yard":    "price_1S4R4dRzSCSZiE1RwOjpcmiV",
      "twice weekly, 2 dogs, small yard":    "price_1S4R4KRzSCSZiE1RO2k16aCE",

      "once weekly, 5+ dogs, large yard":    "price_1S4R1CRzSCSZiE1RGBpPP7OO",
      "once weekly, 5+ dogs, medium yard":   "price_1S4R0aRzSCSZiE1RY5FYLhxr",
      "once weekly, 5+ dogs, small yard":    "price_1S4QzzRzSCSZiE1RVgSAPbCn",

      "once weekly, 4 dogs, large yard":     "price_1S4Qz9RzSCSZiE1RyVU98RV1",
      "once weekly, 4 dogs, medium yard":    "price_1S4QyuRzSCSZiE1RTR1e4Ndc",
      "once weekly, 4 dogs, small yard":     "price_1S4QwLRzSCSZiE1RRbeRHoIL",

      "once weekly, 3 dogs, large yard":     "price_1S4QsrRzSCSZiE1R5f6jtsrB",
      "once weekly, 3 dogs, medium yard":    "price_1S4QrhRzSCSZiE1RGqGvgW6S",

      "once weekly, 2 dogs, large yard":     "price_1S4QqsRzSCSZiE1RsVWQpe3C",
      "once weekly, 2 dogs, medium yard":    "price_1S4Qq9RzSCSZiE1RykiEaQaV",

      "twice weekly, 1 dog, small yard":     "price_1S4QkuRzSCSZiE1RkFC13VKH",

      "once weekly, 2 dogs, small yard":     "price_1S4QdVRzSCSZiE1RKpYBWYke",
      "once weekly, 1 dog, large yard":      "price_1S4QdVRzSCSZiE1RiET0HGih",
      "once weekly, 1 dog, medium yard":     "price_1S4QdVRzSCSZiE1RGlbtpuaU",
      "once weekly, 3 dogs, small yard":     "price_1S4QdVRzSCSZiE1RAeefk5Lc",
      "once weekly, 1 dog, small yard":      "price_1S4FGARzSCSZiE1RcXQ5NV2K"
    };

    function isOneTimeKey(k) { return /^onetime\s/i.test(k); }

    // === ONLY CHANGE: make goToCheckout show the actual server error ===
    async function goToCheckout(priceId, service, optionsKey) {
      try {
        const user = auth.currentUser;
        if (!user) { alert('Please sign in to continue'); return; }
        const token = await user.getIdToken();
        const s = await initStripe();

        console.log('Checkout debug:', { service, optionsKey, priceId });

        const response = await fetch('/api/create-checkout-session', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            priceId,
            service,
            optionsKey,
            mode: isOneTimeKey(optionsKey) ? 'payment' : 'subscription'
          })
        });

        const payload = await response.json().catch(() => ({}));
        if (!response.ok) {
          throw new Error(payload?.error || `Server error (${response.status})`);
        }

        if (!payload?.id) {
          throw new Error('Server did not return a session id');
        }

        await s.redirectToCheckout({ sessionId: payload.id });
      } catch (error) {
        console.error('Checkout error:', error);
        alert('Checkout failed: ' + (error?.message || error));
      }
    }

    function initStripeButtons() {
      document.querySelectorAll('.js-checkout-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const service = serviceTypeEl.value;
          const key = buildKey();
          const priceId = PRICE_IDS[key] || PRICE_IDS[norm(key)];
          if (!priceId) { alert('Please select valid options'); return; }
          await goToCheckout(priceId, service, key);
        });
      });
    }

    initStripeButtons();
    updatePrice();
  </script>
</body>
</html>
