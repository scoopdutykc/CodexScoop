<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Scoop Duty KC — Billing & Customer Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  <style>
    .feature-card { box-shadow: 0 20px 25px -15px rgba(15,118,110,0.35); }
    .step::before { content: attr(data-step); }
  </style>
</head>
<body class="font-sans bg-gray-50 text-gray-800">
  <nav class="bg-white shadow-md sticky top-0 z-50">
    <div class="container mx-auto px-6 py-4">
      <div class="flex justify-between items-center">
        <a href="/" class="text-2xl font-bold text-green-600">
          Scoop Duty <span class="text-green-800">KC</span>
        </a>
        <div class="hidden md:flex space-x-3">
          <a id="navBilling" href="/billing" class="hidden px-4 py-2 rounded-md bg-green-100 text-green-700 font-semibold">Billing</a>
          <button id="loginBtn" class="px-4 py-2 rounded-md bg-green-600 text-white hover:bg-green-700 transition font-medium">Login</button>
          <button id="signupBtn" class="px-4 py-2 rounded-md bg-green-800 text-white hover:bg-green-900 transition font-medium">Sign Up</button>
        </div>
        <button class="md:hidden focus:outline-none"><i data-feather="menu"></i></button>
      </div>
    </div>
  </nav>

  <main>
    <section class="relative overflow-hidden">
      <div class="absolute inset-0 bg-gradient-to-br from-green-600 via-green-500 to-green-700"></div>
      <div class="relative container mx-auto px-6 py-20 text-white">
        <div class="max-w-3xl" data-aos="fade-up">
          <span class="inline-flex items-center gap-2 px-4 py-1 rounded-full bg-white/10 uppercase tracking-widest text-xs font-semibold">
            <i data-feather="credit-card" class="w-4 h-4"></i> Billing Portal
          </span>
          <h1 class="mt-6 text-4xl md:text-5xl font-bold leading-tight">Manage your Scoop Duty account in seconds.</h1>
          <p class="mt-4 text-lg text-white/80">
            Update payment methods, review invoices, and adjust your subscription whenever it fits your schedule. Our secure Stripe-powered customer portal keeps everything in one friendly place.
          </p>
          <div class="mt-8 flex flex-wrap items-center gap-4">
            <a
              href="https://billing.stripe.com/p/login/test_9B6eVf3Xj0bc1rVaIT1gs00"
              data-portal-button
              class="inline-flex items-center gap-3 px-6 py-3 rounded-full bg-white text-green-700 font-semibold shadow-lg hover:-translate-y-0.5 transition"
            >
              <span>Open Customer Portal</span>
              <i data-feather="external-link" class="w-4 h-4"></i>
            </a>
            <span class="text-white/70">Securely hosted by Stripe</span>
          </div>
          <p data-portal-status class="text-white/80 text-sm hidden mt-3"></p>
        </div>
      </div>
    </section>

    <section class="py-16 bg-white">
      <div class="container mx-auto px-6">
        <h2 class="text-3xl font-bold text-center text-gray-900 mb-12" data-aos="fade-up">Everything you need to stay on top of service</h2>
        <div class="grid md:grid-cols-3 gap-8">
          <div class="feature-card bg-white rounded-xl p-8 border border-green-100" data-aos="fade-up" data-aos-delay="0">
            <div class="text-green-600 mb-4"><i data-feather="shield" class="w-10 h-10"></i></div>
            <h3 class="text-xl font-semibold mb-2 text-gray-900">Secure payments</h3>
            <p class="text-gray-600">Stripe’s trusted infrastructure protects every transaction with best-in-class encryption.</p>
          </div>
          <div class="feature-card bg-white rounded-xl p-8 border border-green-100" data-aos="fade-up" data-aos-delay="100">
            <div class="text-green-600 mb-4"><i data-feather="clock" class="w-10 h-10"></i></div>
            <h3 class="text-xl font-semibold mb-2 text-gray-900">Self-serve scheduling</h3>
            <p class="text-gray-600">Pause service for vacations, change your plan, or update visit notes in just a few clicks.</p>
          </div>
          <div class="feature-card bg-white rounded-xl p-8 border border-green-100" data-aos="fade-up" data-aos-delay="200">
            <div class="text-green-600 mb-4"><i data-feather="file-text" class="w-10 h-10"></i></div>
            <h3 class="text-xl font-semibold mb-2 text-gray-900">Transparent history</h3>
            <p class="text-gray-600">Download invoices, track payments, and see your upcoming service dates anytime.</p>
          </div>
        </div>
      </div>
    </section>

    <section class="bg-gray-50 py-16">
      <div class="container mx-auto px-6">
        <div class="grid lg:grid-cols-2 gap-10 items-center">
          <div data-aos="fade-right">
            <h2 class="text-3xl font-bold text-gray-900">How the portal works</h2>
            <p class="mt-4 text-gray-600">
              Whether you’re a brand-new Scoop Duty family or a long-time client, our billing hub keeps everything effortless.
            </p>
            <div class="mt-8 space-y-6">
              <div class="flex items-start gap-4">
                <div class="step flex h-10 w-10 shrink-0 items-center justify-center rounded-full bg-green-100 text-green-700 font-semibold" data-step="1"></div>
                <div>
                  <h3 class="text-lg font-semibold text-gray-900">Log in with Stripe</h3>
                  <p class="text-gray-600">Use your Stripe customer email to authenticate securely.</p>
                </div>
              </div>
              <div class="flex items-start gap-4">
                <div class="step flex h-10 w-10 shrink-0 items-center justify-center rounded-full bg-green-100 text-green-700 font-semibold" data-step="2"></div>
                <div>
                  <h3 class="text-lg font-semibold text-gray-900">Manage your plan</h3>
                  <p class="text-gray-600">Update cards, adjust frequency, and review any add-ons without waiting on email.</p>
                </div>
              </div>
              <div class="flex items-start gap-4">
                <div class="step flex h-10 w-10 shrink-0 items-center justify-center rounded-full bg-green-100 text-green-700 font-semibold" data-step="3"></div>
                <div>
                  <h3 class="text-lg font-semibold text-gray-900">Stay in control</h3>
                  <p class="text-gray-600">Need a hand? Reach out and we’ll jump in—but the power to tweak things lives with you.</p>
                </div>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-2xl border border-green-100 p-10 shadow-lg" data-aos="fade-left">
            <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-green-50 text-green-700 text-sm font-medium">
              <i data-feather="zap" class="w-4 h-4"></i> Fast support
            </div>
            <h3 class="mt-6 text-2xl font-bold text-gray-900">Need help getting in?</h3>
            <p class="mt-3 text-gray-600">
              If you haven’t received a Stripe invite yet, just let us know and we’ll send a fresh link. We’re happy to walk you through the first login.
            </p>
            <div class="mt-6 space-y-2 text-gray-700">
              <div class="flex items-center gap-2">
                <i data-feather="mail" class="w-5 h-5 text-green-500"></i>
                <a href="mailto:hello@scoopdutykc.com" class="hover:text-green-600">hello@scoopdutykc.com</a>
              </div>
              <div class="flex items-center gap-2">
                <i data-feather="phone" class="w-5 h-5 text-green-500"></i>
                <a href="tel:18165350896" class="hover:text-green-600">(816) 535-0896</a>
              </div>
            </div>
            <a
              href="https://billing.stripe.com/p/login/test_9B6eVf3Xj0bc1rVaIT1gs00"
              data-portal-button
              class="mt-8 inline-flex items-center gap-3 px-5 py-3 rounded-lg bg-green-600 text-white font-semibold hover:bg-green-700 transition"
            >
              <span>Launch Stripe Portal</span>
              <i data-feather="arrow-right" class="w-4 h-4"></i>
            </a>
          </div>
        </div>
      </div>
    </section>

    <section class="py-16 bg-green-700 text-white text-center">
      <div class="container mx-auto px-6" data-aos="zoom-in">
        <h2 class="text-3xl font-bold">Ready to update your account?</h2>
        <p class="mt-3 text-white/80 max-w-2xl mx-auto">
          The Scoop Duty billing portal lets you handle payments, review visits, and keep your pet care plan perfectly tuned—all in under a minute.
        </p>
        <a
          href="https://billing.stripe.com/p/login/test_9B6eVf3Xj0bc1rVaIT1gs00"
          data-portal-button
          class="mt-8 inline-flex items-center gap-3 px-8 py-3 rounded-full bg-white text-green-700 font-semibold shadow-lg hover:-translate-y-0.5 transition"
        >
          <span>Go to Customer Portal</span>
          <i data-feather="external-link" class="w-4 h-4"></i>
        </a>
      </div>
    </section>
  </main>

  <footer class="bg-gray-900 text-white py-10">
    <div class="container mx-auto px-6 text-center text-gray-400">
      &copy; 2025 Scoop Duty KC. All rights reserved.
    </div>
  </footer>

  <script>
    const portalShareUrl = 'https://billing.stripe.com/p/login/test_9B6eVf3Xj0bc1rVaIT1gs00';

    const firebaseConfig = {
      apiKey: "AIzaSyBiCaBDOOql_0MO1KRWaATh-ATc60TutMw",
      authDomain: "scoop-duty.firebaseapp.com",
      projectId: "scoop-duty",
      storageBucket: "scoop-duty.firebasestorage.app",
      messagingSenderId: "888851571683",
      appId: "1:888851571683:web:d48f67ba25c6bd780bb6d6"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    AOS.init({ duration: 800, easing: 'ease-in-out', once: true });
    feather.replace();

    auth.onAuthStateChanged((user) => {
      const loginBtn = document.getElementById('loginBtn');
      const signupBtn = document.getElementById('signupBtn');
      if (user) {
        if (loginBtn) loginBtn.textContent = 'Billing';
        if (signupBtn) signupBtn.textContent = 'Logout';
      } else {
        if (loginBtn) loginBtn.textContent = 'Login';
        if (signupBtn) signupBtn.textContent = 'Sign Up';
      }
    });

    const loginBtn = document.getElementById('loginBtn');
    const signupBtn = document.getElementById('signupBtn');

    if (loginBtn) {
      loginBtn.addEventListener('click', () => {
        if (auth.currentUser) {
          window.location.href = '/billing';
        } else {
          const provider = new firebase.auth.GoogleAuthProvider();
          auth.signInWithPopup(provider).catch(err => alert('Login error: ' + (err?.message || err)));
        }
      });
    }

    if (signupBtn) {
      signupBtn.addEventListener('click', () => {
        if (auth.currentUser) {
          auth.signOut();
        } else {
          const provider = new firebase.auth.GoogleAuthProvider();
          auth.signInWithPopup(provider).catch(err => alert('Signup error: ' + (err?.message || err)));
        }
      });
    }

    const portalButtons = Array.from(document.querySelectorAll('[data-portal-button]'));
    const portalStatusEl = document.querySelector('[data-portal-status]');

    function setPortalStatus(message) {
      if (!portalStatusEl) return;
      if (message) {
        portalStatusEl.textContent = message;
        portalStatusEl.classList.remove('hidden');
      } else {
        portalStatusEl.textContent = '';
        portalStatusEl.classList.add('hidden');
      }
    }

    function setPortalButtonLoading(btn, loading) {
      if (!btn.dataset.originalHtml) {
        btn.dataset.originalHtml = btn.innerHTML;
      }
      btn.dataset.loading = loading ? 'true' : 'false';
      btn.setAttribute('aria-busy', loading ? 'true' : 'false');
      btn.classList.toggle('opacity-70', loading);
      btn.classList.toggle('pointer-events-none', loading);
      if (loading) {
        btn.innerHTML = '<span class="inline-flex items-center gap-2">Opening portal…</span>';
      } else {
        btn.innerHTML = btn.dataset.originalHtml;
      }
    }

    async function handlePortalButton(event) {
      const user = auth.currentUser;
      if (!user) return; // fall back to the public Stripe link

      event.preventDefault();
      const btn = event.currentTarget;
      if (btn.dataset.loading === 'true') return;

      setPortalButtonLoading(btn, true);
      setPortalStatus('Generating your secure customer portal…');
      let redirecting = false;

      try {
        const idToken = await user.getIdToken();
        const resp = await fetch('/api/create-portal-session', {
          method: 'POST',
          headers: {
            Authorization: `Bearer ${idToken}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({}),
        });
        const data = await resp.json().catch(() => ({}));
        if (resp.status === 401) await auth.signOut().catch(() => {});
        if (!resp.ok || !data?.url) {
          throw new Error(data?.error || 'Portal session response was invalid');
        }
        redirecting = true;
        setPortalStatus('Redirecting you to Stripe…');
        window.location.href = data.url;
      } catch (err) {
        console.error('Portal open error', err);
        alert('We could not open your customer portal automatically. You will be sent to the standard Stripe login instead.');
        window.location.href = portalShareUrl;
      } finally {
        if (!redirecting) {
          setPortalStatus('');
          setPortalButtonLoading(btn, false);
        }
      }
    }

    portalButtons.forEach((btn) => btn.addEventListener('click', handlePortalButton));
  </script>
</body>
</html>
